# ===========================================
# Jitsi Meet Self-Hosted
# Videoconferência para Universidade MotoChefe
# ===========================================
#
# Uso:
#   cd /var/www/lms/infra/jitsi
#   cp .env.jitsi.example .env
#   # Editar .env com o domínio correto
#   ./setup.sh
#   docker compose -f docker-compose.jitsi.yml up -d
#
# Portas utilizadas:
#   8443 → HTTPS do Jitsi Web (Nginx faz proxy reverso)
#   10000/udp → Jitsi Video Bridge (tráfego de mídia)
#
version: '3.8'

services:
  # ===========================================
  # Jitsi Web - Frontend + Nginx interno
  # ===========================================
  jitsi-web:
    image: jitsi/web:stable-9823
    container_name: motochefe-jitsi-web
    restart: unless-stopped
    ports:
      - "8443:443"
    volumes:
      - ${JITSI_CONFIG:-./jitsi-config}/web:/config:Z
      - ${JITSI_CONFIG:-./jitsi-config}/web/crontabs:/var/spool/cron/crontabs:Z
      - ${JITSI_CONFIG:-./jitsi-config}/transcripts:/usr/share/jitsi-meet/transcripts:Z
      - ./custom-interface_config.js:/config/custom-interface_config.js:Z
    environment:
      - ENABLE_AUTH=${ENABLE_AUTH:-0}
      - ENABLE_GUESTS=${ENABLE_GUESTS:-1}
      - ENABLE_LOBBY=${ENABLE_LOBBY:-0}
      - ENABLE_PREJOIN_PAGE=${ENABLE_PREJOIN_PAGE:-0}
      - ENABLE_WELCOME_PAGE=${ENABLE_WELCOME_PAGE:-0}
      - ENABLE_CLOSE_PAGE=${ENABLE_CLOSE_PAGE:-0}
      - ENABLE_REQUIRE_DISPLAY_NAME=${ENABLE_REQUIRE_DISPLAY_NAME:-0}
      - ENABLE_CALENDAR=${ENABLE_CALENDAR:-0}
      - DISABLE_DEEP_LINKING=${DISABLE_DEEP_LINKING:-1}
      - PUBLIC_URL=${PUBLIC_URL:-https://meet.universidademotochefe.com.br}
      - TZ=${TZ:-America/Sao_Paulo}
      - XMPP_DOMAIN=${XMPP_DOMAIN:-meet.jitsi}
      - XMPP_SERVER=${XMPP_SERVER:-xmpp.meet.jitsi}
      - XMPP_BOSH_URL_BASE=${XMPP_BOSH_URL_BASE:-http://jitsi-xmpp:5280}
      - XMPP_AUTH_DOMAIN=${XMPP_AUTH_DOMAIN:-auth.meet.jitsi}
      - XMPP_MUC_DOMAIN=${XMPP_MUC_DOMAIN:-muc.meet.jitsi}
      - XMPP_GUEST_DOMAIN=${XMPP_GUEST_DOMAIN:-guest.meet.jitsi}
      - JICOFO_AUTH_USER=${JICOFO_AUTH_USER:-focus}
      - JVB_BREWERY_MUC=${JVB_BREWERY_MUC:-jvbbrewery}
    depends_on:
      - jitsi-xmpp
    networks:
      jitsi-meet:
        aliases:
          - ${XMPP_DOMAIN:-meet.jitsi}

  # ===========================================
  # Prosody - Servidor XMPP
  # ===========================================
  jitsi-xmpp:
    image: jitsi/prosody:stable-9823
    container_name: motochefe-jitsi-xmpp
    restart: unless-stopped
    expose:
      - "5222"
      - "5347"
      - "5280"
    volumes:
      - ${JITSI_CONFIG:-./jitsi-config}/prosody/config:/config:Z
      - ${JITSI_CONFIG:-./jitsi-config}/prosody/prosody-plugins-custom:/prosody-plugins-custom:Z
    environment:
      - ENABLE_AUTH=${ENABLE_AUTH:-0}
      - ENABLE_GUESTS=${ENABLE_GUESTS:-1}
      - ENABLE_LOBBY=${ENABLE_LOBBY:-0}
      - AUTH_TYPE=${AUTH_TYPE:-internal}
      - XMPP_DOMAIN=${XMPP_DOMAIN:-meet.jitsi}
      - XMPP_SERVER=${XMPP_SERVER:-xmpp.meet.jitsi}
      - XMPP_AUTH_DOMAIN=${XMPP_AUTH_DOMAIN:-auth.meet.jitsi}
      - XMPP_MUC_DOMAIN=${XMPP_MUC_DOMAIN:-muc.meet.jitsi}
      - XMPP_INTERNAL_MUC_DOMAIN=${XMPP_INTERNAL_MUC_DOMAIN:-internal-muc.meet.jitsi}
      - XMPP_GUEST_DOMAIN=${XMPP_GUEST_DOMAIN:-guest.meet.jitsi}
      - XMPP_MODULES=${XMPP_MODULES:-}
      - XMPP_MUC_MODULES=${XMPP_MUC_MODULES:-}
      - XMPP_INTERNAL_MUC_MODULES=${XMPP_INTERNAL_MUC_MODULES:-}
      - JICOFO_COMPONENT_SECRET=${JICOFO_COMPONENT_SECRET}
      - JICOFO_AUTH_USER=${JICOFO_AUTH_USER:-focus}
      - JICOFO_AUTH_PASSWORD=${JICOFO_AUTH_PASSWORD}
      - JVB_AUTH_USER=${JVB_AUTH_USER:-jvb}
      - JVB_AUTH_PASSWORD=${JVB_AUTH_PASSWORD}
      - TZ=${TZ:-America/Sao_Paulo}
    networks:
      jitsi-meet:
        aliases:
          - ${XMPP_SERVER:-xmpp.meet.jitsi}

  # ===========================================
  # Jicofo - Gerenciador de conferências
  # ===========================================
  jitsi-jicofo:
    image: jitsi/jicofo:stable-9823
    container_name: motochefe-jitsi-jicofo
    restart: unless-stopped
    volumes:
      - ${JITSI_CONFIG:-./jitsi-config}/jicofo:/config:Z
    environment:
      - XMPP_DOMAIN=${XMPP_DOMAIN:-meet.jitsi}
      - XMPP_SERVER=${XMPP_SERVER:-xmpp.meet.jitsi}
      - XMPP_AUTH_DOMAIN=${XMPP_AUTH_DOMAIN:-auth.meet.jitsi}
      - XMPP_INTERNAL_MUC_DOMAIN=${XMPP_INTERNAL_MUC_DOMAIN:-internal-muc.meet.jitsi}
      - XMPP_MUC_DOMAIN=${XMPP_MUC_DOMAIN:-muc.meet.jitsi}
      - JICOFO_COMPONENT_SECRET=${JICOFO_COMPONENT_SECRET}
      - JICOFO_AUTH_USER=${JICOFO_AUTH_USER:-focus}
      - JICOFO_AUTH_PASSWORD=${JICOFO_AUTH_PASSWORD}
      - JVB_BREWERY_MUC=${JVB_BREWERY_MUC:-jvbbrewery}
      - TZ=${TZ:-America/Sao_Paulo}
      - JICOFO_ENABLE_HEALTH_CHECKS=true
    depends_on:
      - jitsi-xmpp
    networks:
      - jitsi-meet

  # ===========================================
  # JVB - Jitsi Video Bridge (tráfego de mídia)
  # ===========================================
  jitsi-jvb:
    image: jitsi/jvb:stable-9823
    container_name: motochefe-jitsi-jvb
    restart: unless-stopped
    ports:
      - "10000:10000/udp"
    volumes:
      - ${JITSI_CONFIG:-./jitsi-config}/jvb:/config:Z
    environment:
      - XMPP_DOMAIN=${XMPP_DOMAIN:-meet.jitsi}
      - XMPP_SERVER=${XMPP_SERVER:-xmpp.meet.jitsi}
      - XMPP_AUTH_DOMAIN=${XMPP_AUTH_DOMAIN:-auth.meet.jitsi}
      - XMPP_INTERNAL_MUC_DOMAIN=${XMPP_INTERNAL_MUC_DOMAIN:-internal-muc.meet.jitsi}
      - JVB_AUTH_USER=${JVB_AUTH_USER:-jvb}
      - JVB_AUTH_PASSWORD=${JVB_AUTH_PASSWORD}
      - JVB_BREWERY_MUC=${JVB_BREWERY_MUC:-jvbbrewery}
      - JVB_PORT=${JVB_PORT:-10000}
      - JVB_STUN_SERVERS=${JVB_STUN_SERVERS:-stun.l.google.com:19302,stun1.l.google.com:19302}
      - PUBLIC_URL=${PUBLIC_URL:-https://meet.universidademotochefe.com.br}
      - JVB_ADVERTISE_IPS=${JVB_ADVERTISE_IPS}
      - TZ=${TZ:-America/Sao_Paulo}
    depends_on:
      - jitsi-xmpp
    networks:
      - jitsi-meet

networks:
  jitsi-meet:
    driver: bridge
